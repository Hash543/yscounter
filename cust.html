<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>悅盛保全 - 櫃台服務系統 - 客戶名稱</title>
    <link href="/css/sticky-footer-navbar.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/colorbox.css" />
    <link rel="stylesheet" href="/css/main.css" />

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/main.css" >
    <script src="/js/jquery.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <!--<script type="text/javascript" src="/js/jquery.colorbox-min.js"></script>-->
    <script type="text/javascript" src="/js/noty/packaged/jquery.noty.packaged.min.js"></script>
    <style>
      h2{
        font-size: 24px;
      }
    </style>
    <script type="text/javascript" src="/js/Common.js"></script>
  </head>
  <body>

    <!-- Fixed navbar -->
    <div class="loadingMask" style="width:100%;height:100%;position:fixed;background: rgba(0,0,0,0.3);z-index:1111;display: none"></div>
    <header>
      <nav class="navbar">
      </nav>  
    </header>
    

    <!-- Begin page content -->
    <div class="container main" >
      <div class="row">
          <div class="col-md-12">
            
            <p>
              <a class="btn btn-default" id="scanEmp" href="#" role="button">開始讀取員工條碼&raquo;</a>
            </p>
          </div>
          <div class="col-md-6" style="display:none" id="pointDetail">
            <div class="alert alert-success" style="width:200px" role="alert">
              您好 
              <strong id="empName">
                
              </strong>
            </div>
            <strong >請選擇駐點清單</strong>
            <div class="list-group pointList">
            </div>
          </div>
          <div class="col-md-12" style="border-bottom: 1px dotted #778899;margin-bottom:20px" >
          </div>
          <div class="col-md-12" align="center">
            <button type="button" class="btn btn-success" id="goWork" style="width:100px;height:44px;line-height: 1;font-size: 20px;font-weight:bold;display:none" aria-haspopup="true" id="offWork" aria-expanded="false">上班打卡</button>
            <button type="button" class="btn btn-warning" id="offWork" style="width:100px;height:44px;line-height: 1;font-size: 20px;font-weight:bold;display:none" aria-haspopup="true" aria-expanded="false">下班打卡</button>
          </div>
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <p class="text-muted">Place sticky footer content here.</p>
      </div>
    </footer>
    <script type="text/javascript">
      var exec = require('child_process').exec,
          child;
      
      $(document).ready(function(){
        var empName= $("#empName");
        var loading = $("#loading");
        var loadingMask = $(".loadingMask");
        var pointList = $(".pointList");
        //$(".viewDetail").colorbox({inline:true, width:"50%"});
        var scanEmpId = "";
        var chooseCust = "";
        var choosePoint = "";
        var gowork = $("#goWork");
        var offwork = $("#offWork");
        var offlinePointFile = "offlinePoint.json";
        var offlineCheckinFile = "offlineCheckin.json";
        var pointData = {};
        var options = {
          hostname: '61.220.182.219',
          port: 80,
          path: ''
        };
        var showPoint = function(pointData,empId){
          loadingMask.css("display","none");
          loading.css("display","none");
          loading.removeClass("rotateIn");
          loading.addClass("rotateOut");
          pointList.empty();
          var resEmpName="";
          http.get(config.apiHost + 'api/empName/000/000/'+empId, (res) => {
            var resContent="";
            res.resume();
            res.on('data',(d) =>{
              resContent+=d;
            });
            res.on('end',(d) =>{
              var resObj = JSON.parse(resContent);
              resEmpName = resObj[0].F_EMP_NAME;
              
              empName.html(resEmpName);
            });
          }).on('error', (e) => {
            console.log(`Got error: ${e.message}`);
          });  
          for(var i in pointData){
            pointList.append('<a href="#" pointid="'+pointData[i].F_POINT_ID+'" class="list-group-item">'+pointData[i].F_POINT_NAME+'</a>');
          }
          $("#pointDetail").show();
          gowork.css("display","none");
          offwork.css("display","none");
        }
        $("#scanEmp").click(function(){
          var pointData={};
          if($(this).attr("disabled")==true){
            return false;
          }
          loadingMask.css("display","block");
          loading.removeClass("rotateOut");
          loading.css("display","block");
          loading.addClass("rotateIn");
          exec("python scan.py" , function(err ,data ,c){
            if(err == null && data.length > 0){
              data = data.trim();
              var parse = data.match(/([A-Z]{1}[0-9]+)([A-Z]?)/);
              scanEmpId = parse[1];
              http.get(config.apiHost + 'api/pointByCust/'+currentCust+'/000/'+scanEmpId, (res) => {
                var resContent="";
                res.resume();
                res.on('data',(d) =>{
                  resContent+=d;
                });
                res.on('end',(d) =>{
                  pointData = JSON.parse(resContent);
                  showPoint(pointData,scanEmpId);
                });
              }).on('error', (e) => {
                console.log(`Got error: ${e.message}`);
                pointData = JSON.parse(fs.readFileSync(offlinePointFile));
                showPoint(pointData,scanEmpId);
              });  
            }else{
              loadingMask.css("display","none");
              loading.css("display","none");
              loading.removeClass("rotateIn");
              loading.addClass("rotateOut");
              console.log(err);
            }
          });
          //$(this).attr("disabled",true);
        });
        pointList.delegate(".list-group-item","click",function(){
          var pointid=$(this).attr("pointid");
          choosePoint = pointid;
          $("a.current").removeClass("current");
          $(this).addClass("current");
          gowork.show();
          offwork.show();
        });
        gowork.click(function(){
          if($(this).attr("disabled") != true){
            checkin("goWork");
          }
        });
        offwork.click(function(){
          if($(this).attr("disabled") != true){
            checkin("offWork");
          }
        });
        var checkin = function(workType){
          var url ;
          if(scanEmpId != "" && choosePoint!=""&&currentCust!=""){
            url = config.apiHost + 'barcode/checkin/'+workType+'/'+currentCust+"/"+choosePoint+"/"+scanEmpId;
            http.get(url , (res) => {
              res.resume();
              res.on('data',(d) =>{
                switch(String(d)){
                  case("3"):
                    alert("打卡完成");
                  break;
                  case("1"):
                    alert("當日未排班");
                  break;
                  case("2"):
                    alert("員工不存在或已離職");
                  break;
                  case("4"):
                    alert("當日未排班");
                  break;
                  case("5"):
                    alert("當日已在其他地方打卡了");
                  break;
                }
                location.href="index.html"
              })
            }).on('error', (e) => {
              fs.stat(offlineCheckinFile,(err)=>{
                var d = new Date();
                var n = d.toLocaleString();
                url = config.apiHost + 'barcode/checkin/'+workType+'/'+currentCust+"/"+choosePoint+"/"+scanEmpId+"/"+n.replace(/\//g,"-");
                var offlineCheckinList;
                var offlineCheckinContent ="";
                offlineCheckinContent = fs.readFileSync(offlineCheckinFile);
                if(err == null && offlineCheckinContent !=""){
                  offlineCheckinList = JSON.parse(offlineCheckinContent);
                  offlineCheckinList.push(url);
                }else{
                  console.log(err);
                  offlineCheckinList = [url];
                }
                fs.appendFile(offlineCheckinFile, JSON.stringify(offlineCheckinList),{flag: "w"}, (err) => {
                  alert("打卡完成!");
                  location.href="index.html";
                  if (err) console.log(err);
                });
              });
            });
          }else{
            alert("資料有錯誤");
          }
        }
      });
    </script>
    <button class="btn btn-lg btn-warning" id="loading" style="display:none;"><span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span>請在20秒內掃描員工識別證</button>
    <script type="text/javascript" src="/js/main.js"></script>
  </body>
</html>
